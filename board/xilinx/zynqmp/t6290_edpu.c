#include <common.h>
#include <command.h>
#include <dm.h>
#include <errno.h>
#include <spi.h>
#include <i2c.h>

#include "t6290_edpu.h"

uint8_t config_dsp1_arr[]=
{
  0xaa, 0x55, 0xaa, 0xff, 0xff, 0xff, 0x07, 0x63, 
  0x10, 0x00, 0xff, 0xff, 0xff, 0x01, 0x86, 0x06, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 
  0xf2, 0x80, 0x10, 0x00, 0x00, 0x00, 0x01, 0xff, 
  0xf2, 0x00, 0x00, 0x00, 0x40, 0x00, 0xbf, 0xff, 
  0xf2, 0x01, 0x04, 0x00, 0x44, 0x01, 0x04, 0xff, 
  0xf2, 0x01, 0x08, 0x98, 0x91, 0x0a, 0x55, 0xff, 
  0xf2, 0x01, 0x0c, 0x0f, 0xb8, 0xa9, 0x1e, 0xff, 
  0xf2, 0x01, 0x00, 0x01, 0x0c, 0x10, 0x00, 0xff, 
  0xf2, 0x01, 0x60, 0x00, 0x00, 0x00, 0x01, 0xff, 
  0xf2, 0x01, 0x64, 0x03, 0x40, 0x14, 0x00, 0xff, 
  0xf2, 0x01, 0x14, 0x24, 0x40, 0x10, 0x00, 0xff, 
  0xf2, 0x01, 0x24, 0x14, 0x50, 0x00, 0x00, 0xff, 
  0xf2, 0x00, 0x80, 0x80, 0x01, 0x43, 0x02, 0xff, 
  0xf2, 0x01, 0x30, 0x02, 0x00, 0x00, 0x00, 0xff, 
  0xf2, 0x01, 0x70, 0x89, 0x08, 0x06, 0x00, 0xff, 
  0xf2, 0x01, 0x74, 0x86, 0x45, 0xf6, 0x08, 0xff, 
  0xf2, 0x0b, 0x28, 0x00, 0x0c, 0x00, 0x00, 0xff, 
  0xf2, 0x01, 0x18, 0x00, 0x44, 0x1a, 0x50, 0xff, 
  0xf2, 0x01, 0x1c, 0x00, 0x10, 0x00, 0x00, 0xff, 
  0xf2, 0x80, 0x10, 0x00, 0x00, 0x00, 0x41, 0xff, 
  0xf2, 0x01, 0x10, 0xc7, 0x04, 0x00, 0x08, 0xff, 
  0xf8, 0x00, 0x6c, 0x00, 0x00, 0x81, 0x57, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0xbf, 0x00, 0x00, 0x04, 0x00, 0x00, 0x02, 0x2c, 
  0xc0, 0x00, 0x00, 0x10, 0xc0, 0x04, 0x00, 0x00, 
  0xbd, 0x3c, 0x42, 0xc3, 0xbf, 0x00, 0x02, 0xb2, 
  0x00, 0x00, 0x04, 0xee, 0xc0, 0x04, 0x00, 0x00, 
  0x30, 0x00, 0x20, 0x01, 0x80, 0x00, 0x38, 0x98, 
  0x20, 0x10, 0xbf, 0xf2, 0x40, 0x90, 0x30, 0xf8, 
  0x3f, 0xf3, 0xbf, 0xff, 0x38, 0x98, 0x20, 0x74, 
  0xbf, 0xf2, 0x40, 0x90, 0x30, 0x00, 0x20, 0xbf, 
  0x80, 0x40, 0x38, 0x18, 0x20, 0x00, 0xbf, 0xf2, 
  0x40, 0x90, 0x30, 0x00, 0x21, 0x04, 0x80, 0x44, 
  0x38, 0x18, 0x21, 0x04, 0xbf, 0xf2, 0x40, 0x90, 
  0x30, 0x10, 0x2a, 0x55, 0x98, 0x91, 0x38, 0x18, 
  0x21, 0x08, 0xbf, 0xf2, 0x40, 0x90, 0x30, 0xa0, 
  0x29, 0x1e, 0x8f, 0xb8, 0x38, 0x18, 0x21, 0x0c, 
  0xbf, 0xf2, 0x40, 0x90, 0x30, 0x00, 0x30, 0x00, 
  0x81, 0x0c, 0x38, 0x18, 0x21, 0x00, 0xbf, 0xf2, 
  0x40, 0x90, 0x30, 0x00, 0x20, 0x01, 0x80, 0x00, 
  0x38, 0x18, 0x21, 0x60, 0xbf, 0xf2, 0x40, 0x90, 
  0x30, 0x00, 0x34, 0x00, 0x83, 0x40, 0x38, 0x18, 
  0x21, 0x64, 0xbf, 0xf2, 0x40, 0x90, 0x30, 0x00, 
  0x30, 0x00, 0xa4, 0x40, 0x38, 0x18, 0x21, 0x14, 
  0xbf, 0xf2, 0x40, 0x90, 0x30, 0x00, 0x20, 0x00, 
  0x94, 0x50, 0x38, 0x18, 0x21, 0x24, 0xbf, 0xf2, 
  0x40, 0x90, 0x30, 0x50, 0x23, 0x02, 0x80, 0x01, 
  0x38, 0x18, 0x20, 0x80, 0xbf, 0xf2, 0x40, 0x90, 
  0x30, 0x00, 0x20, 0x00, 0x82, 0x00, 0x38, 0x18, 
  0x21, 0x30, 0xbf, 0xf2, 0x40, 0x90, 0x29, 0x03, 
  0x80, 0x0e, 0x38, 0x00, 0x3b, 0x00, 0x80, 0xb7, 
  0x9d, 0x48, 0x90, 0xc0, 0x90, 0xc8, 0x30, 0x10, 
  0x26, 0x00, 0x89, 0x08, 0x38, 0x18, 0x21, 0x70, 
  0xbf, 0xf2, 0x40, 0x90, 0x30, 0xf0, 0x36, 0x08, 
  0x86, 0x45, 0x38, 0x18, 0x21, 0x74, 0xbf, 0xf2, 
  0x40, 0x90, 0x30, 0x00, 0x20, 0x00, 0x80, 0x0c, 
  0x38, 0x18, 0x2b, 0x28, 0xbf, 0xf2, 0x40, 0x90, 
  0x30, 0x00, 0x3a, 0x50, 0x80, 0x44, 0x38, 0x18, 
  0x21, 0x18, 0xbf, 0xf2, 0x40, 0x90, 0x30, 0x00, 
  0x20, 0x00, 0x80, 0x10, 0x38, 0x18, 0x21, 0x1c, 
  0xbf, 0xf2, 0x40, 0x90, 0x30, 0x18, 0x20, 0x08, 
  0x87, 0x04, 0x38, 0x18, 0x21, 0x10, 0xbf, 0xf2, 
  0x40, 0x90, 0x29, 0x03, 0x80, 0x0e, 0x38, 0x20, 
  0x36, 0x00, 0x81, 0x6e, 0x9d, 0x48, 0x90, 0xc0, 
  0x90, 0xc8, 0x38, 0x58, 0x28, 0x00, 0xbf, 0xf2, 
  0x50, 0x90, 0x31, 0x00, 0x20, 0x00, 0x9f, 0xc0, 
  0xdc, 0x01, 0x7c, 0x76, 0x93, 0xc1, 0xcc, 0x40, 
  0x93, 0xd0, 0xc8, 0x70, 0x35, 0x1c, 0x22, 0xa4, 
  0x80, 0x04, 0x37, 0x1c, 0x22, 0x62, 0x80, 0x04, 
  0x39, 0xd8, 0x30, 0x00, 0xbf, 0xfa, 0x51, 0x91, 
  0x32, 0x00, 0x20, 0x80, 0x80, 0x00, 0xdc, 0x9a, 
  0x41, 0x91, 0x39, 0xd8, 0x30, 0x08, 0xbf, 0xfa, 
  0x51, 0x91, 0x32, 0x00, 0x21, 0x31, 0x82, 0x05, 
  0xdc, 0x9a, 0x41, 0x91, 0x39, 0xd8, 0x30, 0x20, 
  0xbf, 0xfa, 0x51, 0x91, 0x32, 0x00, 0x20, 0x80, 
  0x80, 0x00, 0xdc, 0x9a, 0x41, 0x91, 0x39, 0xd8, 
  0x30, 0x28, 0xbf, 0xfa, 0x51, 0x91, 0x32, 0x00, 
  0x21, 0x31, 0x82, 0x03, 0xdc, 0x9a, 0x41, 0x91, 
  0x29, 0x03, 0x80, 0x0e, 0x38, 0x00, 0x3b, 0x00, 
  0x80, 0xb7, 0x9d, 0x48, 0x90, 0xc0, 0x90, 0xc8, 
  0x39, 0xd8, 0x30, 0x00, 0xbf, 0xfa, 0x51, 0x91, 
  0x32, 0xf8, 0x3f, 0x7f, 0xbf, 0xff, 0xdc, 0x82, 
  0x41, 0x91, 0x39, 0xd8, 0x30, 0x00, 0xbf, 0xfa, 
  0x51, 0x91, 0x32, 0xf8, 0x3f, 0xbf, 0xbf, 0xff, 
  0xdc, 0x82, 0x41, 0x91, 0x39, 0xd8, 0x30, 0x20, 
  0xbf, 0xfa, 0x51, 0x91, 0x32, 0xf8, 0x3f, 0x7f, 
  0xbf, 0xff, 0xdc, 0x82, 0x41, 0x91, 0x39, 0xd8, 
  0x30, 0x20, 0xbf, 0xfa, 0x51, 0x91, 0x32, 0xf8, 
  0x3f, 0xbf, 0xbf, 0xff, 0xdc, 0x82, 0x41, 0x91, 
  0x39, 0x98, 0x20, 0x0c, 0xbf, 0xf2, 0x51, 0x91, 
  0x32, 0x00, 0x20, 0x80, 0x80, 0x00, 0xdc, 0x82, 
  0x70, 0xea, 0x96, 0xc3, 0x39, 0xd8, 0x30, 0x00, 
  0xbf, 0xfa, 0x92, 0xc3, 0x51, 0x91, 0x96, 0xc3, 
  0x32, 0x10, 0x20, 0x00, 0x88, 0x00, 0x92, 0xc3, 
  0xdc, 0x9a, 0x92, 0xc3, 0x41, 0x91, 0x39, 0x98, 
  0x20, 0x0c, 0xbf, 0xf2, 0x51, 0x91, 0x32, 0x00, 
  0x28, 0x00, 0x80, 0x00, 0xdc, 0x82, 0x70, 0xea, 
  0x96, 0xc3, 0x39, 0xd8, 0x30, 0x20, 0xbf, 0xfa, 
  0x92, 0xc3, 0x51, 0x91, 0x96, 0xc3, 0x32, 0x10, 
  0x20, 0x00, 0x88, 0x00, 0x92, 0xc3, 0xdc, 0x9a, 
  0x92, 0xc3, 0x41, 0x91, 0x29, 0x03, 0x80, 0x0e, 
  0x38, 0x00, 0x2e, 0x00, 0x87, 0x27, 0x9d, 0x48, 
  0x90, 0xc0, 0x90, 0xc8, 0x31, 0x1c, 0x21, 0x2a, 
  0x80, 0x04, 0x39, 0x98, 0x20, 0x0c, 0xbf, 0xf2, 
  0x51, 0x91, 0x32, 0x00, 0x20, 0x80, 0x80, 0x00, 
  0xdc, 0x82, 0x70, 0xea, 0x35, 0x1c, 0x22, 0xa4, 
  0x80, 0x04, 0x39, 0xd8, 0x30, 0x90, 0xbf, 0xfa, 
  0x51, 0x91, 0x32, 0x80, 0x20, 0x00, 0x80, 0x00, 
  0xdc, 0x9a, 0x41, 0x91, 0x39, 0x98, 0x20, 0x0c, 
  0xbf, 0xf2, 0x51, 0x91, 0x32, 0x00, 0x20, 0x80, 
  0x80, 0x00, 0xdc, 0x82, 0x70, 0xea, 0x37, 0x1c, 
  0x21, 0x50, 0x80, 0x04, 0x9f, 0x7a, 0x90, 0xc0, 
  0x90, 0xc0, 0x9f, 0x71, 0x90, 0xc0, 0x90, 0xc0, 
  0x90, 0xc0, 0x3d, 0xd5, 0xc2, 0x2a, 0x3f, 0x00, 
  0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
};

uint8_t config_dsp2_arr[]=
{
  0xaa, 0x55, 0xaa, 0xff, 0xff, 0xff, 0x07, 0x63, 
  0x10, 0x00, 0xff, 0xff, 0xff, 0x01, 0x86, 0x06, 
  0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 
  0xf2, 0x80, 0x10, 0x00, 0x00, 0x00, 0x01, 0xff, 
  0xf2, 0x00, 0x00, 0x00, 0x40, 0x00, 0xbf, 0xff, 
  0xf2, 0x01, 0x04, 0x00, 0x44, 0x01, 0x04, 0xff, 
  0xf2, 0x01, 0x08, 0x98, 0x91, 0x0a, 0x55, 0xff, 
  0xf2, 0x01, 0x0c, 0x0f, 0xb8, 0xa9, 0x1e, 0xff, 
  0xf2, 0x01, 0x00, 0x01, 0x0c, 0x10, 0x00, 0xff, 
  0xf2, 0x01, 0x60, 0x00, 0x00, 0x00, 0x01, 0xff, 
  0xf2, 0x01, 0x64, 0x03, 0x40, 0x14, 0x00, 0xff, 
  0xf2, 0x01, 0x14, 0x24, 0x40, 0x10, 0x00, 0xff, 
  0xf2, 0x01, 0x24, 0x14, 0x50, 0x00, 0x00, 0xff, 
  0xf2, 0x00, 0x80, 0x80, 0x01, 0x43, 0x02, 0xff, 
  0xf2, 0x01, 0x30, 0x02, 0x00, 0x00, 0x00, 0xff, 
  0xf2, 0x01, 0x70, 0x89, 0x08, 0x06, 0x00, 0xff, 
  0xf2, 0x01, 0x74, 0x86, 0x45, 0xf6, 0x08, 0xff, 
  0xf2, 0x0b, 0x28, 0x00, 0x0c, 0x00, 0x00, 0xff, 
  0xf2, 0x01, 0x18, 0x00, 0x44, 0x1a, 0x50, 0xff, 
  0xf2, 0x01, 0x1c, 0x00, 0x10, 0x00, 0x00, 0xff, 
  0xf2, 0x80, 0x10, 0x00, 0x00, 0x00, 0x41, 0xff, 
  0xf2, 0x01, 0x10, 0xc7, 0x04, 0x00, 0x08, 0xff, 
  0xf8, 0x00, 0x6c, 0x00, 0x00, 0x81, 0x57, 0xff, 
  0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
  0xbf, 0x00, 0x00, 0x04, 0x00, 0x00, 0x02, 0x2c, 
  0xc0, 0x00, 0x00, 0x10, 0xc0, 0x04, 0x00, 0x00, 
  0xbd, 0x3c, 0x42, 0xc3, 0xbf, 0x00, 0x02, 0xb2, 
  0x00, 0x00, 0x04, 0xee, 0xc0, 0x04, 0x00, 0x00, 
  0x30, 0x00, 0x20, 0x01, 0x80, 0x00, 0x38, 0x98, 
  0x20, 0x10, 0xbf, 0xf2, 0x40, 0x90, 0x30, 0xf8, 
  0x3f, 0xf3, 0xbf, 0xff, 0x38, 0x98, 0x20, 0x74, 
  0xbf, 0xf2, 0x40, 0x90, 0x30, 0x00, 0x20, 0xbf, 
  0x80, 0x40, 0x38, 0x18, 0x20, 0x00, 0xbf, 0xf2, 
  0x40, 0x90, 0x30, 0x00, 0x21, 0x04, 0x80, 0x44, 
  0x38, 0x18, 0x21, 0x04, 0xbf, 0xf2, 0x40, 0x90, 
  0x30, 0x10, 0x2a, 0x55, 0x98, 0x91, 0x38, 0x18, 
  0x21, 0x08, 0xbf, 0xf2, 0x40, 0x90, 0x30, 0xa0, 
  0x29, 0x1e, 0x8f, 0xb8, 0x38, 0x18, 0x21, 0x0c, 
  0xbf, 0xf2, 0x40, 0x90, 0x30, 0x00, 0x30, 0x00, 
  0x81, 0x0c, 0x38, 0x18, 0x21, 0x00, 0xbf, 0xf2, 
  0x40, 0x90, 0x30, 0x00, 0x20, 0x01, 0x80, 0x00, 
  0x38, 0x18, 0x21, 0x60, 0xbf, 0xf2, 0x40, 0x90, 
  0x30, 0x00, 0x34, 0x00, 0x83, 0x40, 0x38, 0x18, 
  0x21, 0x64, 0xbf, 0xf2, 0x40, 0x90, 0x30, 0x00, 
  0x30, 0x00, 0xa4, 0x40, 0x38, 0x18, 0x21, 0x14, 
  0xbf, 0xf2, 0x40, 0x90, 0x30, 0x00, 0x20, 0x00, 
  0x94, 0x50, 0x38, 0x18, 0x21, 0x24, 0xbf, 0xf2, 
  0x40, 0x90, 0x30, 0x50, 0x23, 0x02, 0x80, 0x01, 
  0x38, 0x18, 0x20, 0x80, 0xbf, 0xf2, 0x40, 0x90, 
  0x30, 0x00, 0x20, 0x00, 0x82, 0x00, 0x38, 0x18, 
  0x21, 0x30, 0xbf, 0xf2, 0x40, 0x90, 0x29, 0x03, 
  0x80, 0x0e, 0x38, 0x00, 0x3b, 0x00, 0x80, 0xb7, 
  0x9d, 0x48, 0x90, 0xc0, 0x90, 0xc8, 0x30, 0x10, 
  0x26, 0x00, 0x89, 0x08, 0x38, 0x18, 0x21, 0x70, 
  0xbf, 0xf2, 0x40, 0x90, 0x30, 0xf0, 0x36, 0x08, 
  0x86, 0x45, 0x38, 0x18, 0x21, 0x74, 0xbf, 0xf2, 
  0x40, 0x90, 0x30, 0x00, 0x20, 0x00, 0x80, 0x0c, 
  0x38, 0x18, 0x2b, 0x28, 0xbf, 0xf2, 0x40, 0x90, 
  0x30, 0x00, 0x3a, 0x50, 0x80, 0x44, 0x38, 0x18, 
  0x21, 0x18, 0xbf, 0xf2, 0x40, 0x90, 0x30, 0x00, 
  0x20, 0x00, 0x80, 0x10, 0x38, 0x18, 0x21, 0x1c, 
  0xbf, 0xf2, 0x40, 0x90, 0x30, 0x18, 0x20, 0x08, 
  0x87, 0x04, 0x38, 0x18, 0x21, 0x10, 0xbf, 0xf2, 
  0x40, 0x90, 0x29, 0x03, 0x80, 0x0e, 0x38, 0x20, 
  0x36, 0x00, 0x81, 0x6e, 0x9d, 0x48, 0x90, 0xc0, 
  0x90, 0xc8, 0x38, 0x58, 0x28, 0x00, 0xbf, 0xf2, 
  0x50, 0x90, 0x31, 0x00, 0x20, 0x00, 0x9f, 0xc0, 
  0xdc, 0x01, 0x7c, 0x76, 0x93, 0xc1, 0xcc, 0x40, 
  0x93, 0xd0, 0xc8, 0x70, 0x35, 0x1c, 0x22, 0xa4, 
  0x80, 0x04, 0x37, 0x1c, 0x22, 0x62, 0x80, 0x04, 
  0x39, 0xd8, 0x30, 0x00, 0xbf, 0xfa, 0x51, 0x91, 
  0x32, 0x00, 0x20, 0x80, 0x80, 0x00, 0xdc, 0x9a, 
  0x41, 0x91, 0x39, 0xd8, 0x30, 0x08, 0xbf, 0xfa, 
  0x51, 0x91, 0x32, 0x00, 0x21, 0x31, 0x82, 0x05, 
  0xdc, 0x9a, 0x41, 0x91, 0x39, 0xd8, 0x30, 0x20, 
  0xbf, 0xfa, 0x51, 0x91, 0x32, 0x00, 0x20, 0x80, 
  0x80, 0x00, 0xdc, 0x9a, 0x41, 0x91, 0x39, 0xd8, 
  0x30, 0x28, 0xbf, 0xfa, 0x51, 0x91, 0x32, 0x00, 
  0x21, 0x31, 0x82, 0x03, 0xdc, 0x9a, 0x41, 0x91, 
  0x29, 0x03, 0x80, 0x0e, 0x38, 0x00, 0x3b, 0x00, 
  0x80, 0xb7, 0x9d, 0x48, 0x90, 0xc0, 0x90, 0xc8, 
  0x39, 0xd8, 0x30, 0x00, 0xbf, 0xfa, 0x51, 0x91, 
  0x32, 0xf8, 0x3f, 0x7f, 0xbf, 0xff, 0xdc, 0x82, 
  0x41, 0x91, 0x39, 0xd8, 0x30, 0x00, 0xbf, 0xfa, 
  0x51, 0x91, 0x32, 0xf8, 0x3f, 0xbf, 0xbf, 0xff, 
  0xdc, 0x82, 0x41, 0x91, 0x39, 0xd8, 0x30, 0x20, 
  0xbf, 0xfa, 0x51, 0x91, 0x32, 0xf8, 0x3f, 0x7f, 
  0xbf, 0xff, 0xdc, 0x82, 0x41, 0x91, 0x39, 0xd8, 
  0x30, 0x20, 0xbf, 0xfa, 0x51, 0x91, 0x32, 0xf8, 
  0x3f, 0xbf, 0xbf, 0xff, 0xdc, 0x82, 0x41, 0x91, 
  0x39, 0x98, 0x20, 0x0c, 0xbf, 0xf2, 0x51, 0x91, 
  0x32, 0x00, 0x20, 0x80, 0x80, 0x00, 0xdc, 0x82, 
  0x70, 0xea, 0x96, 0xc3, 0x39, 0xd8, 0x30, 0x00, 
  0xbf, 0xfa, 0x92, 0xc3, 0x51, 0x91, 0x96, 0xc3, 
  0x32, 0x10, 0x20, 0x00, 0x88, 0x00, 0x92, 0xc3, 
  0xdc, 0x9a, 0x92, 0xc3, 0x41, 0x91, 0x39, 0x98, 
  0x20, 0x0c, 0xbf, 0xf2, 0x51, 0x91, 0x32, 0x00, 
  0x28, 0x00, 0x80, 0x00, 0xdc, 0x82, 0x70, 0xea, 
  0x96, 0xc3, 0x39, 0xd8, 0x30, 0x20, 0xbf, 0xfa, 
  0x92, 0xc3, 0x51, 0x91, 0x96, 0xc3, 0x32, 0x10, 
  0x20, 0x00, 0x88, 0x00, 0x92, 0xc3, 0xdc, 0x9a, 
  0x92, 0xc3, 0x41, 0x91, 0x29, 0x03, 0x80, 0x0e, 
  0x38, 0x00, 0x2e, 0x00, 0x87, 0x27, 0x9d, 0x48, 
  0x90, 0xc0, 0x90, 0xc8, 0x31, 0x1c, 0x21, 0x2a, 
  0x80, 0x04, 0x39, 0x98, 0x20, 0x0c, 0xbf, 0xf2, 
  0x51, 0x91, 0x32, 0x00, 0x20, 0x80, 0x80, 0x00, 
  0xdc, 0x82, 0x70, 0xea, 0x35, 0x1c, 0x22, 0xa4, 
  0x80, 0x04, 0x39, 0xd8, 0x30, 0x90, 0xbf, 0xfa, 
  0x51, 0x91, 0x32, 0x80, 0x20, 0x00, 0x80, 0x00, 
  0xdc, 0x9a, 0x41, 0x91, 0x39, 0x98, 0x20, 0x0c, 
  0xbf, 0xf2, 0x51, 0x91, 0x32, 0x00, 0x20, 0x80, 
  0x80, 0x00, 0xdc, 0x82, 0x70, 0xea, 0x37, 0x1c, 
  0x21, 0x50, 0x80, 0x04, 0x9f, 0x7a, 0x90, 0xc0, 
  0x90, 0xc0, 0x9f, 0x71, 0x90, 0xc0, 0x90, 0xc0, 
  0x90, 0xc0, 0x3d, 0xd5, 0xc2, 0x2a, 0x3f, 0x00, 
  0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xc0, 0x00, 
  0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 
};

#define		DSP_EEPROM_ADDR (0x50)

static void edpu_dsp_select(uint32_t dsp_id){
	if (dsp_id == 0)
		i2c_set_bus_num(2); /*pca9548a channel 1 */
	else
		i2c_set_bus_num(3); /*pca9548a channel 2 */

/*
	ZynqMP> i2c bus
	Bus 0:	zynq_1
	Bus 1:	zynq_1->PCA9548@0x70:0 (PS-PMBUS)
	Bus 2:	zynq_1->PCA9548@0x70:1 (DSP1-EEPROM) --!!
	Bus 3:	zynq_1->PCA9548@0x70:2 (DSP2-EEPROM) --!!
	Bus 4:	zynq_1->PCA9548@0x70:3 (ADT75)
	Bus 5:	zynq_1->PCA9548@0x70:4 (PS-DDR4 SPD)
	Bus 6:	zynq_1->PCA9548@0x70:5 (PL-DDR4 SPD)
	Bus 7:	zynq_1->PCA9548@0x70:6 (PS-USB-SDA)
	Bus 8:	zynq_1->PCA9548@0x70:7 (QSFP+)
*/

	i2c_init(100000, DSP_EEPROM_ADDR); /* eeprom address is 0x50 */
}

static bool edpu_dsp_need_config(uint32_t dsp_id){
	static uint8_t buf[sizeof(config_dsp1_arr)] = {0};
	int i;
	uint8_t *p;
	int ret;
	
	edpu_dsp_select(dsp_id);

	ret = eeprom_read(DSP_EEPROM_ADDR, 0, buf, sizeof(buf));
	if(ret != 0){
		printf("error in eeprom_read\n");
		return 0;
	}

	if(dsp_id == 0)
	  p = config_dsp1_arr;
	else
	  p = config_dsp2_arr;

#if 0
	/* print for debug */
	printf("dsp%d eeprom readback:\n", dsp_id);
	for(i=0; i<sizeof(buf); i++){
	  printf("0x%02x, ", buf[i]);
	  if(i % 8 == 7)
	  	printf("\n");
	}
#endif

	for(i=0; i<sizeof(buf); i++){
		if(p[i] != buf[i]){
		  printf("not match, pos=%d, read=0x%02x, expect=0x%02x\n",i, buf[i], p[i]);
			return 1;
		}
	}
	
	return 0;
}

int edpu_dsp_config_clear(uint32_t dsp_id){
	uint8_t buf[128];
	int i;

	for(i=0; i<sizeof(buf); i++)
		buf[i] = 0;

	edpu_dsp_select(dsp_id);
	for(i=0; i<65536/sizeof(buf); i++){ /* 512K, each write is 128 byte */
		if(0 != eeprom_write(DSP_EEPROM_ADDR, 0, buf, sizeof(buf))){
			printf("clear eeprom error");
			return -EIO;
		}
	}

	return 0;
}
static int edpu_dsp_config(uint32_t dsp_id, uint32_t force){
	uint8_t* p;
	int len;
	int ret;
	
	switch(dsp_id){
		case 0:
			p = config_dsp1_arr;
			len = sizeof(config_dsp1_arr);
			break;
			
		case 1:
			p = config_dsp2_arr;
			len = sizeof(config_dsp2_arr);
			break;
			
		default:
			return -EINVAL;
	}

	if(0 == force){
		if(0 == edpu_dsp_need_config(dsp_id)){
			printf("dsp%d eeprom no need to config\n", dsp_id);
			return 0; 
		}
	}

	printf("configure dsp%d eeprom, data ptr=%p, len=%d\n", dsp_id, p, len);

	edpu_dsp_select(dsp_id);
	ret = eeprom_write(DSP_EEPROM_ADDR, 0, p, len);
	if(ret != 0){
		printf("dsp eeprom_write error %d\n", ret);
		return ret;
	}


	return 0;
}
static int edpu_spi_xfer(uint32_t dout, uint32_t *din)
{
	unsigned int bus = 1;
	unsigned int cs = 0;
	unsigned int mode = SPI_MODE_0;
#ifdef CONFIG_DM_SPI
		char name[30], *str;
		struct udevice *dev;
#endif
	struct spi_slave *slave;
	int ret = 0;

#ifdef CONFIG_DM_SPI
	snprintf(name, sizeof(name), "generic_%d:%d", bus, cs);
	str = strdup(name);
	if (!str)
		return -ENOMEM;
	ret = spi_get_bus_and_cs(bus, cs, 1000000, mode, "spi_generic_drv",
				 str, &dev, &slave);
	if (ret)
		return ret;
#else
	slave = spi_setup_slave(bus, cs, 1000000, mode);
	if (!slave) {
		printf("Invalid device %d:%d\n", bus, cs);
		return -EINVAL;
	}
#endif

	ret = spi_claim_bus(slave);
	if (ret)
		goto done;

	ret = spi_xfer(slave, 32, &dout, din,
					 SPI_XFER_BEGIN | SPI_XFER_END);

#ifndef CONFIG_DM_SPI
		/* We don't get an error code in this case */
		if (ret)
			ret = -EIO;
#endif
		if (ret) {
			printf("Error %d during SPI transaction\n", ret);
		}
	done:
		spi_release_bus(slave);
#ifndef CONFIG_DM_SPI
		spi_free_slave(slave);
#endif

	return ret;
}

int edpu_cpld_write(uint32_t addr, uint32_t data)
{
	uint32_t data_in;
	uint32_t data_out;

	udelay(1000);

	//printf("edpu_cpld_write(0x%04x, 0x%06x)\n", addr, data);
	
	data_out = (addr << 24) | data;
	data_out = htonl(data_out);

	return edpu_spi_xfer(data_out, &data_in);
}

uint32_t edpu_cpld_read(uint32_t addr)
{
	uint32_t data_in;
	uint32_t data_out;
	int ret;
	uint32_t r;

	udelay(1000);

	data_out = (1 << 31) | (addr << 24);
	data_out = htonl(data_out);

	ret = edpu_spi_xfer(data_out, &data_in);

	if(ret){
		printf("edpu_cpld_read error:%d\n", ret);
	}

	r = ntohl(data_in) & 0xffffff;
	//printf("edpu_cpld_read(0x%06x) = 0x%04x)\n", addr, r);
	return r;
}

char* edpu_cpld_version(void){
	static char cpld_ver[32];

	sprintf(cpld_ver, "%x%04x-%x", edpu_cpld_read(T6290_EDPU_REG_VER_YEAR_c),
		edpu_cpld_read(T6290_EDPU_REG_VER_MMDD_c),
		edpu_cpld_read(T6290_EDPU_REG_HW_VER_c));
	return cpld_ver;
}

static void edpu_module_reset(uint32_t en, uint32_t bits){
	uint32_t r;

	r = edpu_cpld_read(T6290_EDPU_REG_MODULE_RESET_c);

	if(en)
		r = r | bits;
	else
		r = r & ~bits;

	edpu_cpld_write(T6290_EDPU_REG_MODULE_RESET_c, r);
}

void board_poweroff(void){
	edpu_cpld_write(T6290_EDPU_REG_POWER_OFF_c, 0x7ff);
}

void board_reset(void){
	edpu_cpld_write(T6290_EDPU_REG_SYS_RESTART_c, 0x7ff);
}

#define EDPU_CPLD_FLASH_CMD_SHIFT (16)
#define EDPU_CPLD_FLASH_READ     (0b000)
#define EDPU_CPLD_FLASH_WRITE    (0b010)
#define EDPU_CPLD_FLASH_ENABLE   (0b100)
#define EDPU_CPLD_FLASH_DISABLE  (0b101)
#define EDPU_CPLD_FLASH_ERASE    (0b111)
#define EDPU_CPLD_FLASH_TRACEID  (0b110)

#define EDPU_CPLD_FLASH_PAGE_INSTRU_SN  (6)
#define EDPU_CPLD_FLASH_PAGE_BOARD_SN   (7)
#define EDPU_CPLD_FLASH_PAGE_MAC_PS     (10)
#define EDPU_CPLD_FLASH_PAGE_MAC_DSP    (11)

static int edpu_cpld_flash_ready(void){
	uint32_t i,r;
	
	/* waiting for done */
	i = 1000;
	do{
		udelay(10*1000);
		r = edpu_cpld_read(T6290_EDPU_REG_UFM_RD_STATUS_c);
		if ((r & 0x01) == 0)
			break;
	}while(i-->0);

	/* check */
	if ((r & 0x01) == 0)
		return 0;
	else
		return -EBUSY;
}

static int edpu_cpld_flash_enable(uint32_t en){

	if(0 != edpu_cpld_flash_ready())
		return -EIO;

	if(en)
		edpu_cpld_write(T6290_EDPU_REG_UFM_CMD_c, (EDPU_CPLD_FLASH_ENABLE << EDPU_CPLD_FLASH_CMD_SHIFT));
	else
		edpu_cpld_write(T6290_EDPU_REG_UFM_CMD_c, (EDPU_CPLD_FLASH_DISABLE << EDPU_CPLD_FLASH_CMD_SHIFT));

	if(0 != edpu_cpld_flash_ready())
		return -EIO;
	else
		return 0;
}

int edpu_cpld_flash_write(uint16_t page_addr, uint16_t* p){
	uint32_t i;
	uint32_t data; 

	if(p == 0)
		return -EINVAL;

	/* enable flash */
	if(0 != edpu_cpld_flash_enable(1))
		return -EIO;

	/* load data */
	for (i=0; i<8; i++){
		data = htons(*p); /* to network-order(big-ending) */
		edpu_cpld_write(T6290_EDPU_REG_UFM_WR_DATA_c, data | (i << 16));
		p++;
	}

	/* issue write */
	edpu_cpld_write(T6290_EDPU_REG_UFM_CMD_c, (EDPU_CPLD_FLASH_WRITE << EDPU_CPLD_FLASH_CMD_SHIFT) | (page_addr & 0xfff));

	/* waiting for done */
	if(0 != edpu_cpld_flash_ready())
		return -EIO;

	/* disable flash */
	if(0 != edpu_cpld_flash_enable(0))
		return -EIO;

	return 0;
}

int edpu_cpld_flash_erase(void){

	/* enable flash */
	if(0 != edpu_cpld_flash_enable(1))
		return -EIO;

	/* erase all flash */
	edpu_cpld_write(T6290_EDPU_REG_UFM_CMD_c, (EDPU_CPLD_FLASH_ERASE << EDPU_CPLD_FLASH_CMD_SHIFT));

	/* wait */
	if(0 != edpu_cpld_flash_ready())
		return -EIO;

	/* disable flash */
	if(0 != edpu_cpld_flash_enable(0))
		return -EIO;

	return 0;
}

int edpu_cpld_flash_read(uint32_t page_addr, uint32_t traceid, uint16_t* p){
	int i;
	
	if(p == 0)
		return -EINVAL;

	/* enable flash */
	if(0 != edpu_cpld_flash_enable(1))
		return -EIO;

	/* issue read */
	if(traceid)
		edpu_cpld_write(T6290_EDPU_REG_UFM_CMD_c, (EDPU_CPLD_FLASH_TRACEID << EDPU_CPLD_FLASH_CMD_SHIFT));
	else
		edpu_cpld_write(T6290_EDPU_REG_UFM_CMD_c, (page_addr & 0xfff));

	/* wait */
	if(0 != edpu_cpld_flash_ready())
		return -EIO;

	/* disable flash */
	if(0 != edpu_cpld_flash_enable(0))
		return -EIO;

	/* read the result */
	for(i=0; i<8; i++){
		*p = (edpu_cpld_read(T6290_EDPU_REG_UFM_RD_DATA0_c + i) & 0xffff);
		*p = ntohs(*p);  /* to host order */
		p++;
	}

	return 0;
}

int edpu_cpld_get_ps_mac(uint8_t* mac1, uint8_t* mac2){
	uint16_t buf[8]={0};
	int i;
	
	edpu_cpld_flash_read(EDPU_CPLD_FLASH_PAGE_MAC_PS, 0, buf);
	
	if(buf[0] != 0){
		uint8_t* p = ((uint8_t*)buf)+2;
		for(i=0; i<6; i++){
			*mac1 = *p;
			//printf("%02x:", *mac1);
			mac1++; p++;
		}
		//printf("\n");
		for(i=0; i<6; i++){
			*mac2 = *p;
			//printf("%02x:", *mac2);
			mac2++; p++;
		}
		//printf("\n");
		return 0;
	}
	
	return -EIO;
}

void edpu_init_eth_mac(void){
	static char fmt[] = "%02X:%02X:%02X:%02X:%02X:%02X";
	char ethaddr[20];
	uint8_t mac1[6],mac2[6];
	if (0 == edpu_cpld_get_ps_mac(mac1, mac2)){
		sprintf(ethaddr, fmt,
				mac1[0], mac1[1], mac1[2],
				mac1[3], mac1[4], mac1[5]);
		env_set("ethaddr", ethaddr); /* not eth0addr */

		sprintf(ethaddr, fmt,
				mac2[0], mac2[1], mac2[2],
				mac2[3], mac2[4], mac2[5]);
		env_set("eth1addr", ethaddr);
	}
}

void edpu_cpld_init(void)
{
	printf("\neDPU CPLD:%s\n", edpu_cpld_version());

	/* put all dsp into reset */
	edpu_module_reset(1, MODULE_RESET_DSP_0 | MODULE_RESET_DSP_1);
	udelay(1*1000);
	
	/* configure dsp i2c eeprom if need */
	//edpu_dsp_config_clear(0);
	edpu_dsp_config(0, 0);
	edpu_dsp_config(1, 0);
	udelay(10*1000);

	/* release dsp */
	edpu_module_reset(0, MODULE_RESET_DSP_0 | MODULE_RESET_DSP_1);

	/* read ps ethernet mac address */
	edpu_init_eth_mac();
}
